 # ---------------- ECS Cluster ----------------

  - name: Create ECS Cluster
    community.aws.ecs_cluster:
      name: "{{ ecs_cluster_name }}"
      state: present
      region: "{{ region }}"

  # ---------------- Task Definition ----------------

  - name: Register ECS Task Definition
    community.aws.ecs_taskdefinition:
      family: "{{ task_family }}"
      network_mode: awsvpc
      requires_compatibilities:
        - FARGATE
      cpu: 256
      memory: 512

      containers:
        - name: "{{ container_name }}"
          image: "{{ container_image }}"
          essential: true

          portMappings:
            - containerPort: "{{ container_port }}"
              protocol: tcp

          environment:

            - name: DB_HOST
              value: "{{ db_host }}"

            - name: DB_NAME
              value: "{{ db_name }}"

            - name: DB_USER
              value: "{{ db_user }}"

            - name: DB_PASS
              value: "{{ db_password }}"

            - name: ENV
              value: production

      state: present
      region: "{{ region }}"
    register: taskdef


 # ---------------- ECS Service (Fargate) ----------------

  - name: Create ECS Fargate Service
    community.aws.ecs_service:
      name: "{{ ecs_service_name }}"
      cluster: "{{ ecs_cluster_name }}"
      task_definition: "{{ taskdef.taskdefinition.taskDefinitionArn }}"
      launch_type: FARGATE
      desired_count: 1

      network_configuration:
        subnets: "{{ private_subnet_ids }}"
        security_groups:
          - "{{ ecs_sg }}"
        assign_public_ip: yes

      load_balancers:
        - targetGroupArn: "{{ tg.target_group_arn }}"
          containerName: "{{ container_name }}"
          containerPort: "{{ container_port }}"

      state: present
      region: "{{ region }}"